<?php

/**
 * File Includes Various Fixes
 *
 * @since Ilmenite 1.0
 * @author Erik Bernskiold
 * @version 1.0
 * @package Ilmenite Framework
 **/

/**
 * Disables wpautop and wptexturize filters for shortcodes
 *
 * @since Ilmenite 1.0
 * 
 **/
function webtreats_formatter($content) {
	$new_content = '';

	/* Matches the contents and the open and closing tags */
	$pattern_full = '{(\[raw\].*?\[/raw\])}is';

	/* Matches just the contents */
	$pattern_contents = '{\[raw\](.*?)\[/raw\]}is';

	/* Divide content into pieces */
	$pieces = preg_split($pattern_full, $content, -1, PREG_SPLIT_DELIM_CAPTURE);

	/* Loop over pieces */
	foreach ($pieces as $piece) {
		/* Look for presence of the shortcode */
		if (preg_match($pattern_contents, $piece, $matches)) {

			/* Append to content (no formatting) */
			$new_content .= $matches[1];
		} else {

			/* Format and append to content */
			$new_content .= wptexturize(wpautop($piece));
		}
	}

	return $new_content;
}

// Remove the 2 main auto-formatters
remove_filter('the_content', 'wpautop');
remove_filter('the_content', 'wptexturize');

// Before displaying for viewing, apply this function
add_filter('the_content', 'webtreats_formatter', 99);
add_filter('widget_text', 'webtreats_formatter', 99);

/**
 * Removes WordPress Generatator Code
 *
 * @since Ilmenite 1.0
 **/
function ilmenite_remove_version() {
	return ''; // Returns nothing for the generator meta.
}

add_filter('the_generator', 'ilmenite_remove_version'); // Performs the removal.

/**
 * Removes unused default profile fields
 *
 * @since Ilmenite 1.0
 **/
/* NEEDS REVISION
function ilmenite_hide_profile_fields( $contactmethods ) {
	unset($contactmethods['aim']); // Hides AIM
	unset($contactmethods['jabber']); // Hides Jabber
	unset($contactmethods['yim']); // Hides YIM
	
	return $contactmethods;
}

add_filter('user_contactmethods','ilmenite_hide_profile_fields',10,1); // Performs the hiding.

/**
 * Adds a series of custom modern profile fields.
 *
 * Usage in profile pages:
 *   <?php echo $curauth->twitter; ?>
 *
 * @since Ilmenite 1.0
 **/
/* NEEDS REVISION
function ilmenite_add_profile_fields($contactmethods) {
	$contactmethods['twitter'] = 'Twitter'; // Adds Twitter
	$contactmethods['facebook'] = 'Facebook'; // Adds Facebook
}

add_filter('user_contactmethods', 'ilmenite_add_profile_fields',10,1); // Performs the adding.